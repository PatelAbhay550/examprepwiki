---
import WikiLayout from '../../layouts/WikiLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Sidebar from '../../components/Sidebar.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import SocialShare from '../../components/SocialShare.astro';
import { getCollection, getEntry, render } from 'astro:content';

export async function getStaticPaths() {
	const studyEntries = await getCollection('study');
	return studyEntries.map((entry) => ({
		params: { slug: entry.id },
		props: { entry },
	}));
}

const { entry } = Astro.props;

if (!entry) {
	return Astro.redirect('/404');
}

const { Content, headings } = await render(entry);

// Generate structured data for article
const structuredData = {
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": entry.data.title,
	"description": entry.data.description,
	"author": {
		"@type": "Person",
		"name": entry.data.author || "Exam Prep Wiki Team"
	},
	"datePublished": entry.data.lastUpdated.toISOString(),
	"dateModified": entry.data.lastUpdated.toISOString(),
	"publisher": {
		"@type": "EducationalOrganization",
		"name": "Exam Prep Wiki",
		"url": Astro.site
	},
	"articleSection": entry.data.subject,
	"keywords": entry.data.tags?.join(', '),
	"educationalLevel": entry.data.difficulty || "intermediate"
};
---

<WikiLayout 
	title={entry.data.title} 
	description={entry.data.description}
	category={entry.data.category}
	keywords={entry.data.tags}
	author={entry.data.author}
	publishDate={entry.data.lastUpdated}
	modifiedDate={entry.data.lastUpdated}
	structuredData={structuredData}
>
	<Header slot="header" />
	<Sidebar slot="sidebar" category={entry.data.category} />
	
	<article class="wiki-article">
		<Breadcrumb items={[
			{ label: 'Study', href: '/study' },
			{ label: entry.data.category.toUpperCase(), href: `/study/${entry.data.category}` },
			{ label: entry.data.subject, href: `/study/${entry.data.category}/${entry.data.subject.toLowerCase().replace(/\s+/g, '-')}` },
			{ label: entry.data.title, href: '#' }
		]} />
		
		<div class="article-header">
			<h1>{entry.data.title}</h1>
			<div class="article-meta">
				<span class="meta-item">
					<strong>Category:</strong> {entry.data.category.toUpperCase()}
				</span>
				<span class="meta-item">
					<strong>Subject:</strong> {entry.data.subject}
				</span>
				{entry.data.difficulty && (
					<span class="meta-item">
						<strong>Level:</strong> {entry.data.difficulty}
					</span>
				)}
				<span class="meta-item">
					<strong>Last Updated:</strong> {new Date(entry.data.lastUpdated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
				</span>
			</div>
			{entry.data.tags && entry.data.tags.length > 0 && (
				<div class="article-tags">
					{entry.data.tags.map((tag) => (
						<span class="tag">{tag}</span>
					))}
				</div>
			)}
		</div>
		
		<div class="article-content">
			<Content />
		</div>
		
		<SocialShare 
			title={entry.data.title} 
			description={entry.data.description}
		/>
		
		{entry.data.references && entry.data.references.length > 0 && (
			<section class="references">
				<h2>References</h2>
				<ol>
					{entry.data.references.map((ref) => (
						<li>
							{ref.url ? (
								<a href={ref.url} target="_blank" rel="noopener">{ref.title}</a>
							) : (
								<span>{ref.title}</span>
							)}
						</li>
					))}
				</ol>
			</section>
		)}
		
		<section class="article-footer">
			<div class="footer-links">
				<a href="/practice?topic=fundamental-rights" class="action-btn">
					‚úèÔ∏è Practice Questions
				</a>
				<a href="/tests?subject=polity" class="action-btn">
					üìã Take a Test
				</a>
				<a href="/videos?topic=fundamental-rights" class="action-btn">
					üé• Watch Videos
				</a>
			</div>
		</section>
	</article>
	
	<TableOfContents slot="toc" headings={headings} />
	
	<Footer slot="footer" />
</WikiLayout>

<style>
	.article-header {
		margin-bottom: var(--space-xl);
		padding-bottom: var(--space-lg);
		border-bottom: 2px solid var(--color-border);
	}
	
	.article-meta {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-md);
		margin-top: var(--space-md);
		font-size: var(--font-size-small);
		color: var(--color-text-secondary);
	}
	
	.meta-item {
		display: flex;
		gap: var(--space-xs);
	}
	
	.article-tags {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-xs);
		margin-top: var(--space-md);
	}
	
	.tag {
		display: inline-block;
		padding: 0.25rem 0.75rem;
		background-color: var(--color-bg-secondary);
		color: var(--color-text-secondary);
		font-size: 0.75rem;
		border-radius: var(--radius-sm);
		border: 1px solid var(--color-border-light);
	}
	
	.article-content {
		line-height: var(--line-height-base);
	}
	
	.references {
		margin-top: var(--space-2xl);
		padding-top: var(--space-xl);
		border-top: 1px solid var(--color-border-light);
	}
	
	.references ol {
		font-size: var(--font-size-small);
	}
	
	.article-footer {
		margin-top: var(--space-2xl);
		padding-top: var(--space-xl);
		border-top: 1px solid var(--color-border-light);
	}
	
	.footer-links {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-md);
	}
	
	.action-btn {
		display: inline-flex;
		align-items: center;
		gap: var(--space-sm);
		padding: var(--space-sm) var(--space-lg);
		background-color: var(--color-bg-secondary);
		color: var(--color-text-primary);
		text-decoration: none;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-sm);
		font-size: var(--font-size-small);
		transition: all 0.2s;
	}
	
	.action-btn:hover {
		background-color: var(--color-bg-tertiary);
		border-color: var(--color-accent-blue);
		transform: translateY(-1px);
		box-shadow: var(--shadow-sm);
	}
</style>
